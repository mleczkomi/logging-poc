input {
	beats {
	    port => 5044
	    host => "0.0.0.0"
	    type => "beats"
  	}
}

filter {
    if [ctxt_request] {
        json {
            source => "[ctxt_request]"
            target => "[request_data]"
        }

        json {
            source => "[request_data][content]"
            target => "[request_data][content]"
        }

        mutate { remove_field => [ "ctxt_request", "[request_data][content][headers]" ] }
    }

    if [request_data][clientIp] {
        mutate {
            replace => { "ip" => "%{[request_data][clientIp]}" }
        }
    }

    if [ctxt_response] {
        json {
            source => "[ctxt_response]"
            target => "[response_data]"
        }

        json {
            source => "[response_data][content]"
            target => "[response_data][content]"
        }

        mutate { remove_field => [ "ctxt_response", "[response_data][content][headers]" ] }
    }

    if "abx-redirector" in [host] {
        if [tags] {
            json {
                    source => "[tags]"
                    target => "[tag]"
            }
        }
    }

    geoip {
        source => "ip"
    }

    if [type] == "gelf" and [git] =~ /.+/ {
        json {
            source => "git"
            target => "git"
        }
    }

    if [type] == "gelf" and [user] =~ /.+/ {
        json {
            source => "user"
            target => "user"
        }
    }
}

output {
    if "abx-redirector" in [host] {
        elasticsearch {
            hosts => "elasticsearch:9200"
            index => "abx-redirector-%{+YYYY.MM.dd}"
        }
    } else if [type] == "beats" {
        elasticsearch {
            hosts => "elasticsearch:9200"
            index => "abx-redirector-beats-%{+YYYY.MM.dd}"
        }
    } else {
        elasticsearch {
            hosts => "elasticsearch:9200"
        }
    }
}

output {
	elasticsearch {
		hosts => elasticsearch
		manage_template => false
    	index => "logstash-%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM}"
	}

    stdout { codec => json }
}
